{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>üîó Relaciones entre Compras</h2>
        
        <!-- Mostrar mensajes flash -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Formulario para agregar relaci√≥n -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-plus-circle"></i> Crear Nueva Relaci√≥n
                </h5>
            </div>
            <div class="card-body">
                <!-- Panel de filtros -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="filtroUbicacionMadre" class="form-label">
                            <i class="bi bi-geo-alt"></i> Filtrar por Ubicaci√≥n
                        </label>
                        <select class="form-select" id="filtroUbicacionMadre">
                            <option value="">üìç Todas las ubicaciones</option>
                            {% for ubicacion in ubicaciones %}
                            <option value="{{ ubicacion.id }}">{{ ubicacion.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="filtroUsuarioMadre" class="form-label">
                            <i class="bi bi-person"></i> Filtrar por Usuario
                        </label>
                        <select class="form-select" id="filtroUsuarioMadre" disabled>
                            <option value="">üë§ Todos los usuarios</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="searchMadre" class="form-label">
                            <i class="bi bi-search"></i> Buscar Producto
                        </label>
                        <input type="text" class="form-control" id="searchMadre" placeholder="Buscar por nombre, serie..." disabled>
                    </div>
                </div>

                <!-- Tabla de Compras Madre -->
                <div class="mb-4">
                    <label class="form-label fw-bold">
                        <i class="bi bi-pc-display"></i> Paso 1: Selecciona la Compra Madre (Doble clic)
                    </label>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 0.375rem;">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 5%" class="text-center">
                                        <i class="bi bi-check-circle"></i>
                                    </th>
                                    <th style="width: 30%">
                                        <i class="bi bi-pc-display"></i> Producto
                                    </th>
                                    <th style="width: 15%">
                                        <i class="bi bi-qrcode"></i> N¬∞ Serie
                                    </th>
                                    <th style="width: 20%">
                                        <i class="bi bi-person"></i> Usuario
                                    </th>
                                    <th style="width: 20%">
                                        <i class="bi bi-geo-alt"></i> Ubicaci√≥n
                                    </th>
                                    <th style="width: 10%">
                                        <i class="bi bi-calendar"></i> Fecha
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tablaComprasMadre">
                                {% if compras_madre %}
                                    {% for compra in compras_madre %}
                                    <tr class="compra-madre-row"
                                        data-id="{{ compra.id }}"
                                        data-usuario-id="{{ compra.usuario_id or '' }}"
                                        data-ubicacion-id="{{ compra.ubicacion_id or '' }}"
                                        data-nombre="{{ compra.nombre or '' }}"
                                        data-serie="{{ compra.numero_serie or '' }}"
                                        style="cursor: pointer; transition: background-color 0.2s;">
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input class="form-check-input radio-madre" type="radio" name="compra_madre" 
                                                       id="madre{{ compra.id }}" value="{{ compra.id }}">
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ compra.nombre or 'N/A' }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ compra.numero_serie or 'Sin serie' }}</span>
                                        </td>
                                        <td>
                                            <i class="bi bi-person-circle text-success"></i>
                                            {{ compra.usuario_nombre or 'No asignado' }}
                                        </td>
                                        <td>
                                            <i class="bi bi-geo-alt-fill text-warning"></i>
                                            {{ compra.ubicacion_nombre or 'N/A' }}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ compra.fecha_compra or '-' }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center py-3">
                                            <span class="text-muted">No hay compras madre disponibles</span>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2">
                        <span class="badge bg-secondary" id="comprasMadreEncontradas">0</span>
                        <span class="text-muted">compras madre encontradas</span>
                    </div>
                </div>

                <!-- Informaci√≥n de la Compra Madre Seleccionada -->
                <div class="alert alert-info" id="infoMadreAlert" style="display: none;">
                    <i class="bi bi-check-circle"></i>
                    <strong>‚úÖ Compra Madre Seleccionada:</strong> <span id="infoMadreTexto"></span>
                </div>

                <!-- Tabla de Sub Compras -->
                <div class="mb-4" id="divSubCompras" style="display: none;">
                    <label class="form-label fw-bold">
                        <i class="bi bi-box"></i> Paso 2: Selecciona la Sub Compra/Componente (Doble clic)
                    </label>
                    <div class="row mb-2">
                        <div class="col-md-12">
                            <input type="text" class="form-control" id="searchHijo" placeholder="üîç Buscar componente por nombre o serie...">
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto; border: 2px solid #dee2e6; border-radius: 0.375rem;">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th style="width: 5%" class="text-center">
                                        <i class="bi bi-check-circle"></i>
                                    </th>
                                    <th style="width: 30%">
                                        <i class="bi bi-box"></i> Componente
                                    </th>
                                    <th style="width: 15%">
                                        <i class="bi bi-qrcode"></i> N¬∞ Serie
                                    </th>
                                    <th style="width: 20%">
                                        <i class="bi bi-person"></i> Usuario
                                    </th>
                                    <th style="width: 20%">
                                        <i class="bi bi-geo-alt"></i> Ubicaci√≥n
                                    </th>
                                    <th style="width: 10%">
                                        <i class="bi bi-calendar"></i> Fecha
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="tablaComprasHijo">
                                <tr>
                                    <td colspan="6" class="text-center py-3">
                                        <span class="text-muted">Selecciona primero una compra madre</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-2">
                        <span class="badge bg-secondary" id="comprasHijoEncontradas">0</span>
                        <span class="text-muted">componentes encontrados</span>
                    </div>
                </div>

                <!-- Informaci√≥n de la Sub Compra Seleccionada -->
                <div class="alert alert-warning" id="infoHijoAlert" style="display: none;">
                    <i class="bi bi-check-circle"></i>
                    <strong>‚úÖ Sub Compra Seleccionada:</strong> <span id="infoHijoTexto"></span>
                </div>

                <!-- Formulario oculto -->
                <form method="POST" action="{{ url_for('agregar_relacion') }}" id="relacionForm" style="display: none;">
                    <input type="hidden" name="id_compra_madre" id="id_compra_madre">
                    <input type="hidden" name="id_sub_compra" id="id_sub_compra">
                </form>

                <!-- Botones de acci√≥n -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end" id="botonesAccion" style="display: none;">
                    <button type="button" class="btn btn-outline-secondary" id="btnLimpiar">
                        <i class="bi bi-arrow-counterclockwise"></i> Limpiar Selecci√≥n
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" id="btnCrearRelacion" disabled>
                        <i class="bi bi-link-45deg"></i> Crear Relaci√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- Panel de filtros para la lista de relaciones -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros de B√∫squeda</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="filterUbicacion" class="form-label">
                            <i class="bi bi-geo-alt"></i> Ubicaci√≥n
                        </label>
                        <select class="form-select" id="filterUbicacion">
                            <option value="">Todas las ubicaciones</option>
                            {% for ubicacion in ubicaciones %}
                            <option value="{{ ubicacion.nombre }}">{{ ubicacion.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterUsuario" class="form-label">
                            <i class="bi bi-person"></i> Usuario
                        </label>
                        <select class="form-select" id="filterUsuario">
                            <option value="">Todos los usuarios</option>
                            {% set usuarios = [] %}
                            {% for relacion in relaciones %}
                                {% if relacion.usuario_madre_nombre and relacion.usuario_madre_nombre not in usuarios %}
                                    {% set _ = usuarios.append(relacion.usuario_madre_nombre) %}
                                {% endif %}
                            {% endfor %}
                            {% for usuario in usuarios|sort %}
                            <option value="{{ usuario }}">{{ usuario }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="filterProducto" class="form-label">
                            <i class="bi bi-pc-display"></i> Producto Madre
                        </label>
                        <input type="text" class="form-control" id="filterProducto" placeholder="Buscar producto...">
                    </div>
                    <div class="col-md-3">
                        <label for="filterSerie" class="form-label">
                            <i class="bi bi-qrcode"></i> N¬∞ Serie
                        </label>
                        <input type="text" class="form-control" id="filterSerie" placeholder="Buscar serie...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <button class="btn btn-outline-secondary" id="resetFilters">
                                <i class="bi bi-arrow-counterclockwise"></i> Limpiar Filtros
                            </button>
                            <div>
                                <span class="badge bg-success fs-6" id="relacionesFiltradas">0</span>
                                <span class="ms-2 text-muted">relaciones mostradas</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de relaciones -->
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Lista de Relaciones</h5>
                <div>
                    <span class="badge bg-light text-dark fs-6" id="relacionesCount">{{ relaciones|length }}</span>
                    <span class="ms-2">en total</span>
                </div>
            </div>
            <div class="card-body p-0">
                {% if relaciones|length == 0 %}
                    <div class="alert alert-info text-center m-3">
                        <i class="bi bi-info-circle"></i> No hay relaciones creadas. ¬°Comienza creando tu primera relaci√≥n!
                    </div>
                {% else %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 25%">
                                    <i class="bi bi-pc-display"></i> Compra Madre
                                </th>
                                <th style="width: 12%">
                                    <i class="bi bi-person"></i> Usuario
                                </th>
                                <th style="width: 15%">
                                    <i class="bi bi-geo-alt"></i> Ubicaci√≥n
                                </th>
                                <th style="width: 25%">
                                    <i class="bi bi-box"></i> Sub Compra
                                </th>
                                <th style="width: 15%">
                                    <i class="bi bi-qrcode"></i> N¬∞ Series
                                </th>
                                <th style="width: 8%" class="text-center">
                                    <i class="bi bi-gear"></i> Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tablaRelacionesList">
                            {% for relacion in relaciones %}
                            <tr class="relacion-row" 
                                data-usuario="{{ relacion.usuario_madre_nombre or '' }}"
                                data-ubicacion="{{ relacion.ubicacion_madre or '' }}"
                                data-producto="{{ relacion.producto_madre_nombre or '' }}"
                                data-serie="{{ relacion.serie_madre or '' }}">
                                <td>
                                    <div>
                                        <strong class="text-primary">{{ relacion.producto_madre_nombre }}</strong><br>
                                        <small class="text-muted">ID: {{ relacion.compra_madre_id }}</small>
                                    </div>
                                </td>
                                <td>
                                    <i class="bi bi-person-circle text-info"></i>
                                    {{ relacion.usuario_madre_nombre or 'Sin usuario' }}
                                </td>
                                <td>
                                    <i class="bi bi-geo-alt-fill text-warning"></i>
                                    {{ relacion.ubicacion_madre or 'N/A' }}
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ relacion.producto_hija_nombre }}</strong><br>
                                        <small class="text-muted">ID: {{ relacion.sub_compra_id }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        {% if relacion.serie_madre %}
                                        <span class="badge bg-info">{{ relacion.serie_madre }}</span>
                                        {% endif %}
                                        {% if relacion.serie_hija %}
                                        <span class="badge bg-warning text-dark">{{ relacion.serie_hija }}</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                title="Ver detalles"
                                                onclick="verDetalles({{ relacion.id }})">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <a href="{{ url_for('eliminar_relacion', id=relacion.id) }}" 
                                           class="btn btn-sm btn-outline-danger" 
                                           title="Eliminar relaci√≥n"
                                           onclick="return confirm('¬øEst√° seguro de eliminar esta relaci√≥n?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalles de relaci√≥n -->
<div class="modal fade" id="detallesModal" tabindex="-1" aria-labelledby="detallesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="detallesModalLabel">
                    <i class="bi bi-info-circle"></i> Detalles de la Relaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalDetallesBody">
                <!-- Los detalles se cargar√°n aqu√≠ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Script de relaciones cargado');
    
    // Datos de compras
    const comprasMadre = [
        {% for compra in compras_madre %}
        {
            id: "{{ compra.id }}",
            nombre: "{{ compra.nombre }}",
            numero_serie: "{{ compra.numero_serie or '' }}",
            usuario_id: "{{ compra.usuario_id }}",
            usuario_nombre: "{{ compra.usuario_nombre }}",
            ubicacion_id: "{{ compra.ubicacion_id or '' }}",
            ubicacion_nombre: "{{ compra.ubicacion_nombre or '' }}",
            fecha_compra: "{{ compra.fecha_compra or '' }}"
        },
        {% endfor %}
    ];

    const comprasHijo = [
        {% for compra in compras_hijo %}
        {
            id: "{{ compra.id }}",
            nombre: "{{ compra.nombre }}",
            numero_serie: "{{ compra.numero_serie or '' }}",
            usuario_id: "{{ compra.usuario_id }}",
            usuario_nombre: "{{ compra.usuario_nombre }}",
            ubicacion_id: "{{ compra.ubicacion_id or '' }}",
            ubicacion_nombre: "{{ compra.ubicacion_nombre or '' }}",
            fecha_compra: "{{ compra.fecha_compra or '' }}"
        },
        {% endfor %}
    ];

    // ========== ELEMENTOS DEL DOM ==========
    const filtroUbicacionMadre = document.getElementById('filtroUbicacionMadre');
    const filtroUsuarioMadre = document.getElementById('filtroUsuarioMadre');
    const searchMadre = document.getElementById('searchMadre');
    const searchHijo = document.getElementById('searchHijo');
    const tablaComprasMadreBody = document.getElementById('tablaComprasMadre');
    const tablaComprasHijoBody = document.getElementById('tablaComprasHijo');
    const infoMadreAlert = document.getElementById('infoMadreAlert');
    const infoMadreTexto = document.getElementById('infoMadreTexto');
    const infoHijoAlert = document.getElementById('infoHijoAlert');
    const infoHijoTexto = document.getElementById('infoHijoTexto');
    const divSubCompras = document.getElementById('divSubCompras');
    const botonesAccion = document.getElementById('botonesAccion');
    const btnCrearRelacion = document.getElementById('btnCrearRelacion');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const inputMadre = document.getElementById('id_compra_madre');
    const inputHijo = document.getElementById('id_sub_compra');
    const form = document.getElementById('relacionForm');
    const comprasMadreEncontradas = document.getElementById('comprasMadreEncontradas');
    const comprasHijoEncontradas = document.getElementById('comprasHijoEncontradas');

    let madreSeleccionada = null;
    let hijoSeleccionado = null;

    // ========== CONSTRUIR MAPA DE UBICACIONES A USUARIOS ==========
    function construirMapa() {
        const mapa = {};
        comprasMadre.forEach(compra => {
            if (compra.ubicacion_id && compra.usuario_id) {
                if (!mapa[compra.ubicacion_id]) {
                    mapa[compra.ubicacion_id] = new Set();
                }
                mapa[compra.ubicacion_id].add(compra.usuario_id);
            }
        });
        return mapa;
    }

    const mapaUbicacionesUsuarios = construirMapa();

    // ========== ACTUALIZAR USUARIOS POR UBICACI√ìN ==========
    function actualizarUsuarios() {
        const ubicacionId = filtroUbicacionMadre.value;
        filtroUsuarioMadre.innerHTML = '<option value="">üë§ Todos los usuarios</option>';
        filtroUsuarioMadre.disabled = !ubicacionId;

        if (ubicacionId && mapaUbicacionesUsuarios[ubicacionId]) {
            const usuarios = Array.from(mapaUbicacionesUsuarios[ubicacionId]);
            const usuariosObjs = comprasMadre
                .filter(c => usuarios.includes(c.usuario_id))
                .map(c => ({ id: c.usuario_id, nombre: c.usuario_nombre }))
                .filter((v, i, a) => a.findIndex(u => u.id === v.id) === i)
                .sort((a, b) => a.nombre.localeCompare(b.nombre));

            usuariosObjs.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario.id;
                option.textContent = usuario.nombre;
                filtroUsuarioMadre.appendChild(option);
            });
        }

        actualizarTablaComprasMadre();
    }

    // ========== ACTUALIZAR TABLA COMPRAS MADRE ==========
    function actualizarTablaComprasMadre() {
        const ubicacionId = filtroUbicacionMadre.value;
        const usuarioId = filtroUsuarioMadre.value;
        const busqueda = searchMadre.value.toLowerCase();

        let comprasFiltradas = comprasMadre.filter(c => {
            const coincideUbicacion = !ubicacionId || c.ubicacion_id === ubicacionId;
            const coincideUsuario = !usuarioId || c.usuario_id === usuarioId;
            const coincideBusqueda = !busqueda || 
                c.nombre.toLowerCase().includes(busqueda) || 
                c.numero_serie.toLowerCase().includes(busqueda);
            return coincideUbicacion && coincideUsuario && coincideBusqueda;
        });

        tablaComprasMadreBody.innerHTML = '';
        comprasMadreEncontradas.textContent = comprasFiltradas.length;

        if (comprasFiltradas.length === 0) {
            tablaComprasMadreBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-3">
                        <span class="text-muted">No hay compras madre disponibles</span>
                    </td>
                </tr>
            `;
            return;
        }

        comprasFiltradas.forEach(compra => {
            const fila = document.createElement('tr');
            fila.className = 'compra-madre-row';
            fila.setAttribute('data-id', compra.id);
            fila.setAttribute('data-usuario-id', compra.usuario_id);
            fila.setAttribute('data-nombre', compra.nombre);
            fila.setAttribute('data-serie', compra.numero_serie);
            fila.setAttribute('data-usuario-nombre', compra.usuario_nombre);
            fila.setAttribute('data-ubicacion-nombre', compra.ubicacion_nombre);
            fila.style.cursor = 'pointer';
            fila.style.transition = 'background-color 0.2s';

            fila.innerHTML = `
                <td class="text-center">
                    <div class="form-check">
                        <input class="form-check-input radio-madre" type="radio" name="compra_madre" value="${compra.id}">
                    </div>
                </td>
                <td><strong>${compra.nombre}</strong></td>
                <td><span class="badge bg-info">${compra.numero_serie || 'Sin serie'}</span></td>
                <td><i class="bi bi-person-circle text-success"></i> ${compra.usuario_nombre}</td>
                <td><i class="bi bi-geo-alt-fill text-warning"></i> ${compra.ubicacion_nombre || 'N/A'}</td>
                <td><small class="text-muted">${compra.fecha_compra || '-'}</small></td>
            `;

            // Doble clic
            fila.addEventListener('dblclick', function(e) {
                e.preventDefault();
                const radio = fila.querySelector('.radio-madre');
                if (radio && fila.style.display !== 'none') {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change', { bubbles: true }));
                    fila.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        fila.style.backgroundColor = '';
                    }, 300);
                    console.log('‚ö° Madre seleccionada por doble clic');
                }
            });

            // Hover
            fila.addEventListener('mouseenter', function() {
                if (fila.style.display !== 'none') {
                    fila.style.backgroundColor = '#f8f9fa';
                }
            });

            fila.addEventListener('mouseleave', function() {
                if (!fila.querySelector('.radio-madre').checked) {
                    fila.style.backgroundColor = '';
                }
            });

            tablaComprasMadreBody.appendChild(fila);
        });

        // Event listeners para radios de madre
        document.querySelectorAll('.radio-madre').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    const fila = this.closest('.compra-madre-row');
                    madreSeleccionada = {
                        id: fila.getAttribute('data-id'),
                        nombre: fila.getAttribute('data-nombre'),
                        serie: fila.getAttribute('data-serie'),
                        usuario_id: fila.getAttribute('data-usuario-id'),
                        usuario_nombre: fila.getAttribute('data-usuario-nombre'),
                        ubicacion_nombre: fila.getAttribute('data-ubicacion-nombre')
                    };

                    inputMadre.value = madreSeleccionada.id;
                    infoMadreTexto.innerHTML = `
                        <i class="bi bi-pc-display"></i> ${madreSeleccionada.nombre} 
                        ${madreSeleccionada.serie ? `(${madreSeleccionada.serie})` : ''} 
                        - üë§ ${madreSeleccionada.usuario_nombre}
                    `;
                    infoMadreAlert.style.display = 'block';
                    divSubCompras.style.display = 'block';
                    botonesAccion.style.display = 'flex';

                    // Limpiar hijo
                    hijoSeleccionado = null;
                    inputHijo.value = '';
                    infoHijoAlert.style.display = 'none';
                    btnCrearRelacion.disabled = true;

                    // Llenar tabla de hijos
                    actualizarTablaComprasHijo();
                }
            });
        });
    }

    // ========== ACTUALIZAR TABLA COMPRAS HIJO ==========
    function actualizarTablaComprasHijo() {
        if (!madreSeleccionada) {
            tablaComprasHijoBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-3">
                        <span class="text-muted">Selecciona primero una compra madre</span>
                    </td>
                </tr>
            `;
            return;
        }

        const busqueda = searchHijo.value.toLowerCase();
        let comprasFiltradas = comprasHijo.filter(c => {
            const mismoUsuario = c.usuario_id === madreSeleccionada.usuario_id;
            const coincideBusqueda = !busqueda || 
                c.nombre.toLowerCase().includes(busqueda) || 
                c.numero_serie.toLowerCase().includes(busqueda);
            return mismoUsuario && coincideBusqueda;
        });

        tablaComprasHijoBody.innerHTML = '';
        comprasHijoEncontradas.textContent = comprasFiltradas.length;

        if (comprasFiltradas.length === 0) {
            tablaComprasHijoBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-3">
                        <span class="text-muted">No hay componentes disponibles para este usuario</span>
                    </td>
                </tr>
            `;
            return;
        }

        comprasFiltradas.forEach(compra => {
            const fila = document.createElement('tr');
            fila.className = 'compra-hijo-row';
            fila.setAttribute('data-id', compra.id);
            fila.setAttribute('data-nombre', compra.nombre);
            fila.setAttribute('data-serie', compra.numero_serie);
            fila.style.cursor = 'pointer';
            fila.style.transition = 'background-color 0.2s';

            fila.innerHTML = `
                <td class="text-center">
                    <div class="form-check">
                        <input class="form-check-input radio-hijo" type="radio" name="compra_hijo" value="${compra.id}">
                    </div>
                </td>
                <td><strong>${compra.nombre}</strong></td>
                <td><span class="badge bg-warning text-dark">${compra.numero_serie || 'Sin serie'}</span></td>
                <td><i class="bi bi-person-circle text-success"></i> ${compra.usuario_nombre}</td>
                <td><i class="bi bi-geo-alt-fill text-warning"></i> ${compra.ubicacion_nombre || 'N/A'}</td>
                <td><small class="text-muted">${compra.fecha_compra || '-'}</small></td>
            `;

            // Doble clic
            fila.addEventListener('dblclick', function(e) {
                e.preventDefault();
                const radio = fila.querySelector('.radio-hijo');
                if (radio && fila.style.display !== 'none') {
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change', { bubbles: true }));
                    fila.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        fila.style.backgroundColor = '';
                    }, 300);
                    console.log('‚ö° Hijo seleccionado por doble clic');
                }
            });

            // Hover
            fila.addEventListener('mouseenter', function() {
                if (fila.style.display !== 'none') {
                    fila.style.backgroundColor = '#f8f9fa';
                }
            });

            fila.addEventListener('mouseleave', function() {
                if (!fila.querySelector('.radio-hijo').checked) {
                    fila.style.backgroundColor = '';
                }
            });

            tablaComprasHijoBody.appendChild(fila);
        });

        // Event listeners para radios de hijo
        document.querySelectorAll('.radio-hijo').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    const fila = this.closest('.compra-hijo-row');
                    hijoSeleccionado = {
                        id: fila.getAttribute('data-id'),
                        nombre: fila.getAttribute('data-nombre'),
                        serie: fila.getAttribute('data-serie')
                    };

                    inputHijo.value = hijoSeleccionado.id;
                    infoHijoTexto.innerHTML = `
                        <i class="bi bi-box"></i> ${hijoSeleccionado.nombre} 
                        ${hijoSeleccionado.serie ? `(${hijoSeleccionado.serie})` : ''}
                    `;
                    infoHijoAlert.style.display = 'block';
                    btnCrearRelacion.disabled = false;

                    console.log('‚úÖ Relaci√≥n lista para crear');
                }
            });
        });
    }

    // ========== EVENT LISTENERS ==========
    filtroUbicacionMadre.addEventListener('change', actualizarUsuarios);
    filtroUsuarioMadre.addEventListener('change', actualizarTablaComprasMadre);
    searchMadre.addEventListener('keyup', actualizarTablaComprasMadre);
    searchHijo.addEventListener('keyup', actualizarTablaComprasHijo);

    btnLimpiar.addEventListener('click', function(e) {
        e.preventDefault();
        filtroUbicacionMadre.value = '';
        filtroUsuarioMadre.value = '';
        searchMadre.value = '';
        searchHijo.value = '';
        madreSeleccionada = null;
        hijoSeleccionado = null;
        inputMadre.value = '';
        inputHijo.value = '';
        infoMadreAlert.style.display = 'none';
        infoHijoAlert.style.display = 'none';
        divSubCompras.style.display = 'none';
        botonesAccion.style.display = 'none';
        btnCrearRelacion.disabled = true;
        console.log('üîÑ Selecciones limpias');
        actualizarTablaComprasMadre();
    });

    btnCrearRelacion.addEventListener('click', function(e) {
        e.preventDefault();
        if (inputMadre.value && inputHijo.value) {
            form.submit();
        }
    });

    // ========== FILTRADO DE TABLA DE RELACIONES ==========
    const filterUbicacion = document.getElementById('filterUbicacion');
    const filterUsuario = document.getElementById('filterUsuario');
    const filterProducto = document.getElementById('filterProducto');
    const filterSerie = document.getElementById('filterSerie');
    const tablaRelacionesList = document.getElementById('tablaRelacionesList');
    const filasRelaciones = tablaRelacionesList ? tablaRelacionesList.getElementsByClassName('relacion-row') : [];
    const contadorFiltradas = document.getElementById('relacionesFiltradas');

    function filtrarTabla() {
        const ubicacionFiltro = filterUbicacion.value.toLowerCase();
        const usuarioFiltro = filterUsuario.value.toLowerCase();
        const productoFiltro = filterProducto.value.toLowerCase();
        const serieFiltro = filterSerie.value.toLowerCase();

        let totalFiltradas = 0;

        Array.from(filasRelaciones).forEach(fila => {
            const ubicacion = (fila.getAttribute('data-ubicacion') || '').toLowerCase();
            const usuario = (fila.getAttribute('data-usuario') || '').toLowerCase();
            const producto = (fila.getAttribute('data-producto') || '').toLowerCase();
            const serie = (fila.getAttribute('data-serie') || '').toLowerCase();

            const mostrar = 
                (ubicacionFiltro === '' || ubicacion.includes(ubicacionFiltro)) &&
                (usuarioFiltro === '' || usuario.includes(usuarioFiltro)) &&
                (productoFiltro === '' || producto.includes(productoFiltro)) &&
                (serieFiltro === '' || serie.includes(serieFiltro));

            fila.style.display = mostrar ? '' : 'none';
            if (mostrar) totalFiltradas++;
        });

        contadorFiltradas.textContent = totalFiltradas;
    }

    filterUbicacion.addEventListener('change', filtrarTabla);
    filterUsuario.addEventListener('change', filtrarTabla);
    filterProducto.addEventListener('keyup', filtrarTabla);
    filterSerie.addEventListener('keyup', filtrarTabla);

    document.getElementById('resetFilters').addEventListener('click', function(e) {
        e.preventDefault();
        filterUbicacion.value = '';
        filterUsuario.value = '';
        filterProducto.value = '';
        filterSerie.value = '';
        Array.from(filasRelaciones).forEach(fila => {
            fila.style.display = '';
        });
        contadorFiltradas.textContent = filasRelaciones.length;
    });

    filtrarTabla();

    // ========== MODAL DE DETALLES ==========
    window.verDetalles = function(id) {
        const relaciones = {{ relaciones|tojson|safe }};
        const relacion = relaciones.find(rel => rel.id === id);
        
        if (relacion) {
            const modalBody = document.getElementById('modalDetallesBody');
            modalBody.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-pc-display"></i> Compra Madre
                                </h6>
                            </div>
                            <div class="card-body">
                                <p><strong>${relacion.producto_madre_nombre}</strong></p>
                                <p class="text-muted">ID: ${relacion.compra_madre_id}</p>
                                <p>Series: <span class="badge bg-info">${relacion.serie_madre || 'Sin serie'}</span></p>
                                <p>üë§ ${relacion.usuario_madre_nombre || 'Sin usuario'}</p>
                                <p><i class="bi bi-geo-alt"></i> ${relacion.ubicacion_madre || 'Sin ubicaci√≥n'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="bi bi-box"></i> Sub Compra
                                </h6>
                            </div>
                            <div class="card-body">
                                <p><strong>${relacion.producto_hija_nombre}</strong></p>
                                <p class="text-muted">ID: ${relacion.sub_compra_id}</p>
                                <p>Series: <span class="badge bg-warning text-dark">${relacion.serie_hija || 'Sin serie'}</span></p>
                                <p>üë§ ${relacion.usuario_hija_nombre || 'Sin usuario'}</p>
                                <p><i class="bi bi-geo-alt"></i> ${relacion.ubicacion_hija || 'Sin ubicaci√≥n'}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('detallesModal'));
            modal.show();
        }
    };

    console.log('‚úÖ Script completamente inicializado');
});
</script>
{% endblock %}