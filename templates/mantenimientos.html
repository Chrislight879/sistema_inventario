{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>游댢 Mantenimientos</h2>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- Formulario para agregar/editar mantenimiento -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>{{ 'Editar Mantenimiento' if mantenimiento_edit else 'Agregar Nuevo Mantenimiento' }}</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for(mantenimiento_edit and 'editar_mantenimiento' or 'agregar_mantenimiento', id=mantenimiento_edit.id if mantenimiento_edit) }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="compra" class="form-label">Compra *</label>
                                <select class="form-select" id="compra" name="compra" required>
                                    <option value="">Seleccionar compra</option>
                                    {% for compra in compras %}
                                    <option value="{{ compra.id }}" 
                                            {{ 'selected' if mantenimiento_edit and mantenimiento_edit.compra_id == compra.id }}>
                                        {{ compra.numero_serie }} - {{ compra.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="problema_presentado" class="form-label">Problema Presentado *</label>
                                <input type="text" class="form-control" id="problema_presentado" name="problema_presentado" 
                                       value="{{ mantenimiento_edit.problema if mantenimiento_edit }}" 
                                       required placeholder="Ej: Pantalla no enciende">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="fecha_inicio" class="form-label">Fecha de Inicio</label>
                                <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio" 
                                       value="{{ mantenimiento_edit.fecha_inicio if mantenimiento_edit }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="fecha_final" class="form-label">Fecha de Finalizaci칩n</label>
                                <input type="date" class="form-control" id="fecha_final" name="fecha_final" 
                                       value="{{ mantenimiento_edit.fecha_final if mantenimiento_edit }}">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="diagnostico" class="form-label">Diagn칩stico</label>
                                <input type="text" class="form-control" id="diagnostico" name="diagnostico" 
                                       value="{{ mantenimiento_edit.diagnostico if mantenimiento_edit }}" 
                                       placeholder="Ej: Cambio de pantalla">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observaciones" name="observaciones" rows="3" 
                                  placeholder="Observaciones adicionales...">{{ mantenimiento_edit.observaciones if mantenimiento_edit }}</textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        {{ 'Actualizar' if mantenimiento_edit else 'Agregar' }}
                    </button>
                    {% if mantenimiento_edit %}
                    <a href="{{ url_for('mantenimientos') }}" class="btn btn-secondary">Cancelar</a>
                    {% endif %}
                </form>
            </div>
        </div>

        <!-- Lista de mantenimientos -->
        <div class="card">
            <div class="card-header">
                <h5>Lista de Mantenimientos</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>N춿 Serie</th>
                                <th>Producto</th>
                                <th>Problema</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Final</th>
                                <th>Diagn칩stico</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mantenimiento in mantenimientos %}
                            <tr>
                                <td>{{ mantenimiento.id }}</td>
                                <td>{{ mantenimiento.numero_serie or 'N/A' }}</td>
                                <td>{{ mantenimiento.producto_nombre or 'N/A' }}</td>
                                <td>
                                    {% if mantenimiento.problema %}
                                        {{ mantenimiento.problema[:50] }}{% if mantenimiento.problema|length > 50 %}...{% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ mantenimiento.fecha_inicio or '-' }}</td>
                                <td>{{ mantenimiento.fecha_final or '-' }}</td>
                                <td>
                                    {% if mantenimiento.diagnostico %}
                                        {{ mantenimiento.diagnostico[:30] }}{% if mantenimiento.diagnostico|length > 30 %}...{% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('mantenimientos', editar=mantenimiento.id) }}" 
                                       class="btn btn-sm btn-warning">Editar</a>
                                    <a href="{{ url_for('eliminar_mantenimiento', id=mantenimiento.id) }}" 
                                       class="btn btn-sm btn-danger" 
                                       onclick="return confirm('쮼st치 seguro de eliminar este mantenimiento?')">Eliminar</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}