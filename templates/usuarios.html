{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2> Usuarios</h2>
        
        <!-- DEBUG: Mostrar informaci贸n de variables -->
        <div class="alert alert-info d-none">
            <small>
                DEBUG: <br>
                Usuarios count: {{ usuarios|length }}<br>
                Ubicaciones count: {{ ubicaciones|length }}<br>
                Usuario edit: {{ usuario_edit }}<br>
                Primera ubicaci贸n: {{ ubicaciones[0] if ubicaciones else 'No hay' }}
            </small>
        </div>
        
        <!-- Formulario para agregar/editar usuario -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>{% if usuario_edit %}Editar Usuario{% else %}Agregar Nuevo Usuario{% endif %}</h5>
            </div>
            <div class="card-body">
                <form method="POST" 
                      action="{% if usuario_edit %}{{ url_for('editar_usuario', id=usuario_edit.id) }}{% else %}{{ url_for('agregar_usuario') }}{% endif %}">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="nombre" class="form-label">Nombre del Usuario</label>
                                <input type="text" class="form-control" id="nombre" name="nombre" 
                                       value="{{ usuario_edit.nombre if usuario_edit else '' }}" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="ubicacion" class="form-label">Ubicaci贸n</label>
                                <select class="form-select" id="ubicacion" name="ubicacion" required>
                                    <option value="">Seleccionar ubicaci贸n</option>
                                    {% if ubicaciones %}
                                        {% for ubicacion in ubicaciones %}
                                        <option value="{{ ubicacion.id }}"
                                                {% if usuario_edit and usuario_edit.ubicacion_id == ubicacion.id %}selected{% endif %}>
                                            {{ ubicacion.nombre }}
                                        </option>
                                        {% endfor %}
                                    {% else %}
                                        <option value="" disabled>No hay ubicaciones disponibles</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="ubicacion_especifica" class="form-label">Ubicaci贸n Espec铆fica (opcional)</label>
                                <input type="text" class="form-control" id="ubicacion_especifica" name="ubicacion_especifica" 
                                       value="{{ usuario_edit.ubicacion_especifica if usuario_edit else '' }}">
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="mb-3 d-grid">
                                <button type="submit" class="btn btn-primary">
                                    {% if usuario_edit %}Actualizar{% else %}Agregar{% endif %}
                                </button>
                                {% if usuario_edit %}
                                <a href="{{ url_for('usuarios') }}" class="btn btn-secondary mt-2">Cancelar</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de usuarios -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Lista de Usuarios</h5>
                <span class="badge bg-primary">{{ usuarios|length }} usuarios</span>
            </div>
            <div class="card-body">
                {% if usuarios %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Edificio</th>
                                <th>Ubicaci贸n Espec铆fica</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usuario in usuarios %}
                            <tr>
                                <td>{{ usuario.nombre }}</td>
                                <td>{{ usuario.ubicacion_nombre or 'No asignado' }}</td>
                                <td>{{ usuario.ubicacion_especifica or '-' }}</td>
                                <td>
                                    <a href="{{ url_for('usuarios') }}?editar={{ usuario.id }}" 
                                       class="btn btn-sm btn-warning">Editar</a>
                                    <a href="{{ url_for('eliminar_usuario', id=usuario.id) }}" 
                                       class="btn btn-sm btn-danger" 
                                       onclick="return confirm('驴Est谩 seguro de eliminar este usuario?')">Eliminar</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    No hay usuarios registrados. Agrega un nuevo usuario.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Debug: mostrar informaci贸n en consola
    const usuariosData = JSON.parse('{{ usuarios|tojson|safe }}');
    const ubicacionesData = JSON.parse('{{ ubicaciones|tojson|safe }}');
    console.log("Usuarios en template:", usuariosData);
    console.log("Ubicaciones en template:", ubicacionesData);
    
    // Validaci贸n simple del formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        const nombre = document.getElementById('nombre').value.trim();
        const ubicacion = document.getElementById('ubicacion').value;
        
        if (!nombre || !ubicacion) {
            e.preventDefault();
            alert('Por favor complete todos los campos requeridos');
        }
    });
</script>
{% endblock %}